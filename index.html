<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ShimeChamhoc â€“ Full Features</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
  <script>
    function sanitizeHTML(input) {
      const html = String(input ?? "");
      const doc = new DOMParser().parseFromString(html, "text/html");
      doc.querySelectorAll(
        "script, style, iframe, object, embed, link, meta, base, form"
      ).forEach(el => el.remove());

      // Allowlist for <img> hosts (optional). Empty => allow any https host.
      const ALLOWED_IMG_HOSTS = new Set([
        // "i.imgur.com",
        // "images.unsplash.com",
        // "raw.githubusercontent.com",
      ]);

      const isSafeUrl = (url, { allowDataImage = false, allowHttp = false } = {}) => {
        const v = String(url || "").trim();
        if (!v) return true;

        const lower = v.toLowerCase();

        // allow same-origin / relative URLs
        if (lower.startsWith("#") || lower.startsWith("/") || lower.startsWith("./") || lower.startsWith("../")) return true;

        // allow mailto
        if (lower.startsWith("mailto:")) return true;

        // allow data:image/*;base64,...
        if (allowDataImage && lower.startsWith("data:image/")) {
          // basic validation: must include ;base64,
          return lower.includes(";base64,");
        }

        // block dangerous schemes
        if (
          lower.startsWith("javascript:") ||
          lower.startsWith("vbscript:") ||
          lower.startsWith("file:") ||
          lower.startsWith("blob:") ||
          lower.startsWith("data:")
        ) return false;

        // allow http/https (prefer https)
        if (lower.startsWith("https://") || (allowHttp && lower.startsWith("http://"))) {
          try {
            const u = new URL(v);
            if (ALLOWED_IMG_HOSTS.size === 0) return true;
            return ALLOWED_IMG_HOSTS.has(u.host);
          } catch {
            return false;
          }
        }
        return false;
      };

      doc.querySelectorAll("*").forEach(el => {
        const tag = el.tagName.toLowerCase();

        // Strip all inline event handlers + style
        [...el.attributes].forEach(attr => {
          const name = attr.name.toLowerCase();
          const value = String(attr.value || "").trim();

          if (name.startsWith("on")) {
            el.removeAttribute(attr.name);
            return;
          }
          if (name === "style") {
            el.removeAttribute(attr.name);
            return;
          }

          if (name === "href") {
            if (!isSafeUrl(value)) el.removeAttribute(attr.name);
            return;
          }

          if (name === "src") {
            if (tag === "img") {
              // allow base64 images OR https URLs (optional allowlist by host)
              if (!isSafeUrl(value, { allowDataImage: true, allowHttp: false })) {
                el.removeAttribute(attr.name);
              }
            } else {
              if (!isSafeUrl(value)) el.removeAttribute(attr.name);
            }
            return;
          }

          // Remove potentially risky attributes on non-img tags
          if (tag !== "img") {
            if (name === "srcset") el.removeAttribute(attr.name);
          }
        });

        // For <img>, keep only a small allowlist of attributes
        if (tag === "img") {
          const allowed = new Set(["src", "alt", "title", "width", "height", "loading", "decoding"]);
          [...el.attributes].forEach(attr => {
            if (!allowed.has(attr.name.toLowerCase())) el.removeAttribute(attr.name);
          });
          if (!el.getAttribute("loading")) el.setAttribute("loading", "lazy");
          if (!el.getAttribute("decoding")) el.setAttribute("decoding", "async");
        }
      });

      return doc.body.innerHTML;
    }

    let searchKeywordN = ''; 
    let currentQuizIndex = 0;
    let searchKeyword = '';
    let isSubmitted = false;
    let qCells = [];      // lÆ°u DOM cá»§a tá»«ng Ã´ theo index
    let mapBuilt = false; // Ä‘Ã£ build map chÆ°a
    let currentCellIndex = -1;
    window.MathJax = {
      tex: { inlineMath: [['\\$','\\$'], ['$', '$']] }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
  <header>
    <div class="wrap headerbar">
      <div class="brand">ğŸ“˜ ShimeChamhoc</div>

      <!-- Desktop actions -->
      <div class="headerActions desktopActions">
        <button class="btn secondary" id="btnLoadJson" onclick="$('#fileInput').click()">Náº¡p JSON</button>
<button class="btn secondary" id="btnLoadTextbook" onclick="openTextbookImporter()">ğŸ“„ Náº¡p giÃ¡o trÃ¬nh</button>
<button class="btn ghost" id="toggleTheme">ğŸŒ™ / â˜€ï¸</button>
<button class="btn ghost" id="btnHelp">â“ HÆ°á»›ng dáº«n</button>

      </div>

      <!-- Mobile compact menu -->
      <div class="mobileMenuWrap">
        <button class="btn secondary" id="btnTools">â˜° CÃ´ng cá»¥</button>
        <div class="toolMenu" id="toolMenu">
          <button class="btn secondary" id="mLoadJson">Náº¡p JSON</button>
          <button class="btn secondary" id="mLoadTextbook">ğŸ“„ Náº¡p giÃ¡o trÃ¬nh</button>
          <button class="btn ghost" id="mTheme">ğŸŒ™ / â˜€ï¸</button>
          <button class="btn ghost" id="mHelp">â“ HÆ°á»›ng dáº«n</button>

        </div>
      </div>
    </div>
  </header>

  <main class="wrap" style="margin-top:24px">
    <div class="row">
      <aside class="card pad">
        <h3>CÃ i Ä‘áº·t</h3>
        <div class="grid">
          <div class="grid muted" id="subjectSelectGroup" style="display:none">
          <label>Chá»n mÃ´n</label>
            <select id="subjectSelect"></select>
            </div>
          <div class="grid muted" id="quizSelectGroup" style="display:none">
            <label>Chá»n bá»™ Ä‘á»</label>
            <select id="quizSelect"></select>
          </div>
          <div class="grid muted">
            <label>Thá»i gian (phÃºt)</label>
            <input type="number" id="timeLimit" min="0" value="0" style="padding:10px; border-radius:8px; background:#0d1424; color:white; border:1px solid var(--border)"/>
          </div>
          <div style="display:flex;gap:10px" class="muted">
            <input type="checkbox" id="shuffle" checked /> <label for="shuffle">XÃ¡o trá»™n Ä‘á»</label>
          </div>
          <div style="display:flex;gap:10px" class="muted">
            <input type="checkbox" id="instant" checked /> <label for="instant">Cháº¥m tá»©c thÃ¬</label>
          </div>
          <div style="display:flex;gap:10px" class="muted">
            <input type="checkbox" id="autoNext" /> <label for="autoNext">Tá»± chuyá»ƒn cÃ¢u</label>
          </div>
          <button class="btn ok" id="btnStart" style="width:100%; margin-top:10px">Báº¯t Ä‘áº§u</button>
          <hr style="border:none;border-top:1px solid var(--border);margin:14px 0">

          <div class="grid muted">
            <label>Táº¡o Ä‘á» thi (trá»™n chÆ°Æ¡ng)</label>

            <div style="display:flex; gap:10px; align-items:center">
              <span style="min-width:110px">Sá»‘ cÃ¢u</span>
              <input type="number" id="examCount" min="10" max="200" value="60"
                style="flex:1;padding:10px;border-radius:8px;background:#0d1424;color:white;border:1px solid var(--border)"/>
            </div>

            <div style="display:flex; gap:10px; align-items:center">
              <span style="min-width:110px">% Ch1</span>
              <input type="number" id="p1" min="0" max="100" value="10"
                style="flex:1;padding:10px;border-radius:8px;background:#0d1424;color:white;border:1px solid var(--border)"/>
            </div>

            <div style="display:flex; gap:10px; align-items:center">
              <span style="min-width:110px">% Ch2</span>
              <input type="number" id="p2" min="0" max="100" value="45"
                style="flex:1;padding:10px;border-radius:8px;background:#0d1424;color:white;border:1px solid var(--border)"/>
            </div>

            <div style="display:flex; gap:10px; align-items:center">
              <span style="min-width:110px">% Ch3</span>
              <input type="number" id="p3" min="0" max="100" value="45"
                style="flex:1;padding:10px;border-radius:8px;background:#0d1424;color:white;border:1px solid var(--border)"/>
            </div>

            <button class="btn secondary" id="btnMakeExam" style="width:100%">
              ğŸ“ Táº¡o Ä‘á» thi
            </button>

            <div class="muted" id="examInfo" style="font-size:12px"></div>
          </div>
        </div>
      </aside>

      <section class="card pad" id="panelMain">
        <div id="screenIntro">
          <h2 style="margin-top:0">Sáºµn sÃ ng chÆ°a?</h2>
          <p class="muted" id="statusMessage">Äang chá» dá»¯ liá»‡u...</p>
          <input type="file" id="fileInput" accept="application/json" style="display:none" />
          <input type="file" id="textbookInput" accept=".txt,.md,.html,text/plain,text/markdown,text/html" style="display:none" />
        </div>

        <div id="screenQuiz" style="display:none">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
            <span class="pill" id="qIndex"></span>

            <div style="display:flex;align-items:center;gap:14px">
              <span id="bookmarkBtn" class="bookmark-btn">â­</span>
              <div class="timer pill" id="timer">--:--</div>
            </div>
          </div>

          <div id="qText" style="font-size:20px;font-weight:700;margin-bottom:24px;"></div>
          <div id="qChoices" class="grid"></div>
          <div style="display:flex;justify-content:space-between;margin-top:30px; border-top: 1px solid var(--border); padding-top:20px">
            <button class="btn secondary" id="btnPrev">â† TrÆ°á»›c</button>
            <div style="display:flex; gap:10px">
              <button class="btn ok" id="btnNext">Tiáº¿p â†’</button>
              <button class="btn warn" id="btnSubmit">Ná»™p bÃ i</button>
            </div>
          </div>
          <div id="explain" class="muted" style="margin-top:15px; padding:12px; background:rgba(255,255,255,0.03); border-radius:10px"></div>
          <button class="btn secondary" id="btnAIExplain" style="margin-top:10px">
            ğŸ¤– Giáº£i thÃ­ch báº±ng AI
          </button>
          <div id="questionMap" class="card pad" style="margin-top:20px">
            <div style="font-weight:700;margin-bottom:10px">ğŸ“‹ Tá»•ng quan cÃ¢u há»i</div>

            <!-- FILTER BUTTONS -->
            <div style="display:flex;gap:8px;margin-bottom:10px">
              <button class="btn secondary" id="filterAll">Táº¥t cáº£</button>
              <button class="btn secondary" id="filterBookmark">â­ Bookmark</button>
              <button class="btn secondary" id="filterWrong">âŒ CÃ¢u sai</button>
            </div>
            <input id="searchBox" placeholder="TÃ¬m cÃ¢u há»i..." 
              style="width:100%; padding:10px; border-radius:10px;
              background:rgba(255,255,255,0.03); color:var(--text);
              border:1px solid var(--border); margin-bottom:10px;">

            <div id="questionGrid"
              style="display:grid;grid-template-columns:repeat(auto-fill,40px);gap:8px">
            </div>
          </div>
        </div>

        <div id="screenResult" style="display:none">
          <h2 style="color: var(--ok)">HoÃ n thÃ nh!</h2>
          <p id="scoreLine" style="font-size: 1.5rem; font-weight: 800;"></p>
          <div class="progress" style="margin:20px 0"><div id="scoreBar"></div></div>
          <div style="display:flex; gap:10px; margin-bottom:20px">
            <button class="btn ok" onclick="location.reload()">LÃ m Ä‘á» khÃ¡c</button>
          </div>
          <div id="reviewArea"></div>
        </div>
      </section>
    </div>
  </main>

  <div id="sheepPopup">
    <div class="box">
      <img src="sheep.png" alt="Sheep sticker">
      <div style="font-weight:800">Cá»‘ gáº¯ng lÃªnnn! ğŸ‘</div>
      <p class="muted">Sai 3 cÃ¢u rá»“i Ä‘Ã³, bÃ¬nh tÄ©nh nhÃ©!</p>
      <button class="btn ok"
        onclick="$('#sheepPopup').style.display='none'; wrongStreak=0; sheepOpen=false; lastWrongKey='';">
        Tiáº¿p tá»¥c
      </button>
    </div>
  </div>

  <!-- ===== TEXTBOOK IMPORTER MODAL ===== -->
  <div id="importerModal" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.65);backdrop-filter:blur(6px);z-index:9996;">
    <div class="card pad" style="max-width:920px;width:min(920px,92vw);max-height:84vh;overflow:auto;">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;">
        <div>
          <div style="font-weight:800;font-size:1.1rem">ğŸ“„ Nháº­p giÃ¡o trÃ¬nh â†’ Táº¡o JSON</div>
          <div class="muted" style="margin-top:2px">Há»— trá»£ nhanh: TXT/MD/HTML (copy/paste hoáº·c táº£i file). PDF scan cáº§n OCR (mÃ¬nh hÆ°á»›ng dáº«n sau).</div>
        </div>
        <button class="btn secondary" onclick="closeTextbookImporter()">âœ–</button>
      </div>

      <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:14px">
        <button class="btn secondary" onclick="$('#textbookInput').click()">ğŸ“ Chá»n file</button>
        <button class="btn secondary" onclick="importerPasteExample()">ğŸ§ª DÃ¡n vÃ­ dá»¥</button>
        <button class="btn ok" onclick="importerParse()">âš™ï¸ Táº¡o quiz JSON</button>
        <button class="btn secondary" id="btnDownloadGenerated" onclick="downloadGeneratedJSON()" disabled>â¬‡ï¸ Táº£i JSON</button>
      </div>

      <div class="grid" style="margin-top:12px">
        <label class="muted">Ná»™i dung giÃ¡o trÃ¬nh (cÃ³ thá»ƒ dÃ¡n nguyÃªn chÆ°Æ¡ng + Ä‘Ã¡p Ã¡n)</label>
        <textarea id="textbookArea" style="width:100%;min-height:220px;resize:vertical;padding:12px;border-radius:12px;background:rgba(255,255,255,0.03);color:var(--text);border:1px solid var(--border)"></textarea>

        <div style="display:flex;gap:14px;flex-wrap:wrap;align-items:center" class="muted">
          <label style="display:flex;gap:8px;align-items:center"><input type="checkbox" id="splitByChapter" checked> TÃ¡ch theo chÆ°Æ¡ng</label>
          <label style="display:flex;gap:8px;align-items:center"><input type="checkbox" id="keepAnswerInExplanation" checked> Náº¿u thiáº¿u Ä‘Ã¡p Ã¡n â†’ nhÃ©t vÃ o "giáº£i thÃ­ch"</label>
          <label style="display:flex;gap:8px;align-items:center"><input type="checkbox" id="autoLoadAfterParse" checked> Náº¡p luÃ´n vÃ o quiz sau khi táº¡o</label>
        </div>

        <div id="importerReport" class="muted" style="padding:12px;border-radius:12px;background:rgba(255,255,255,0.03);border:1px solid var(--border)"></div>
      </div>
    </div>
  </div>
<!-- ===== WELCOME TOUR ===== -->
<div id="tourWelcome" style="display:none">
  <div class="box">
    <h3>ğŸ‘‹ ChÃ o má»«ng Ä‘áº¿n vá»›i ShimeChamhoc</h3>
    <p class="muted">Báº¡n cÃ³ muá»‘n Ä‘Æ°á»£c hÆ°á»›ng dáº«n cÃ¡ch sá»­ dá»¥ng nhanh khÃ´ng?</p>
    <div style="display:flex;gap:10px;justify-content:center;margin-top:14px">
      <button class="btn ok" id="tourYes">CÃ³</button>
      <button class="btn secondary" id="tourNo">KhÃ´ng cáº§n</button>
    </div>
  </div>
</div>

<div id="tourOverlay" style="display:none">
  <div id="tourSpotlight"></div>
  <div id="tourTooltip">
    <div id="tourText"></div>
  <div class="actions">
  <button class="btn secondary" id="tourPrev">â†</button>
  <button class="btn ok" id="tourNext">Tiáº¿p â†’</button>
  <button class="btn secondary" id="tourDim">Tá»‘i</button>
  <button class="btn secondary" id="tourBright">SÃ¡ng</button>
  <button class="btn warn" id="tourSkip">Bá» qua</button>
</div>

  </div>
</div>
  <script src="script.js"></script>
  <canvas id="fireworks"></canvas>
  <div id="congratsText">ğŸ‰ ChÃºc má»«ng báº¡n Ä‘Ã£ hoÃ n thÃ nh bÃ i lÃ m!</div>
  <div id="resultOverlay"></div>


</body>
</html>